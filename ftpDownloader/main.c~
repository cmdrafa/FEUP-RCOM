#include "url.h"

int main(int argc, char *argv[])
{
    urlStruct * url = malloc(sizeof(urlStruct));

    if (argc != 2) {  
        fprintf(stderr,"usage: getip address\n");
        exit(1);
    }
    getUrlInfo(argv[1], url);

        free(url->user);
        free(url->password);
        free(url->urlPath);
        free(url);
        return 0;
}

void getUrlInfo(char * completeString, urlStruct * url) {
    if(strncmp(completeString, "ftp://", 6)) {
        printf("Wrong Url on argument, expected begining like: 'ftp://'\n");
        exit(1);
    }
    //######################## debug code ########################
    char debugString[MAX_STRING_DEBUG_SIZE];
    char debugString_2[MAX_STRING_DEBUG_SIZE];
    char debugString_3[MAX_STRING_DEBUG_SIZE];
    char debugString_4[MAX_STRING_DEBUG_SIZE];
    char debugString_5[MAX_STRING_DEBUG_SIZE];
    //######################## debug code ########################

    char * at = strchr(completeString, '@');
    if (at == NULL) {
        printf("ERROR - Wrong paramater -> URL | Expected something like: ftp://[<user>:<password>@]<host>/<url-path>\n");
        exit(1);
    }

    char * toTwoPoints = strchr(completeString + 6, ':');
    char * slashAfterAt = strchr(at, '/');

    if (toTwoPoints == NULL || slashAfterAt == NULL) {
        printf("ERROR - Wrong paramater -> URL | Expected something like: ftp://[<user>:<password>@]<host>/<url-path>\n");
        exit(1);
    }

    int lengthOfUserAndPassword = (int) (at - completeString - 6);
    int lengthOfUser = (int) (toTwoPoints - completeString - 6);
    int lengthOfPassword = lengthOfUserAndPassword - lengthOfUser - 1;
    int lengthOfHost = (int) (slashAfterAt - at - 1);
    int lengthOfUrlPath = strlen(completeString) - (9 + lengthOfUser + lengthOfPassword + lengthOfHost);

    if(lengthOfHost <= 0 || lengthOfUser <= 0 || lengthOfUrlPath <= 0) {
        printf("ERROR - Wrong paramater -> URL | Expected something like: ftp://[<user>:<password>@]<host>/<url-path>\n");
        exit(1);
    }

    //######################## debug code ########################
    sprintf(debugString, "%d", lengthOfUser);
    sprintf(debugString_2, "%d", lengthOfPassword);
    sprintf(debugString_3, "%d", lengthOfHost);
    sprintf(debugString_5, "%d", lengthOfUrlPath);
    debug("Number of characters of the User     ", debugString);
    debug("Number of characters of the Password ", debugString_2);
    debug("Number of characters of the Host     ", debugString_3);
    debug("Number of characters of the Url Path ", debugString_5);
    //######################## debug code ########################

    url->user = malloc(sizeof(char) * lengthOfUser);
    url->password = malloc(sizeof(char) * lengthOfPassword);
    url->urlPath = malloc(sizeof(char) * lengthOfUrlPath);
    char hostTemp[MAX_STRING_DEBUG_SIZE];

    strncpy(url->user, completeString + 6, lengthOfUser);
    strncpy(url->password, completeString + lengthOfUser + 7, lengthOfPassword);
    strncpy(hostTemp, at + 1, lengthOfHost);
    strncpy(url->urlPath, slashAfterAt + 1, lengthOfUrlPath);
    hostTemp[lengthOfHost] = '\0';

    //######################## debug code ########################
    debug("User field                           ", url->user);
    debug("Password field                       ", url->password);
    debug("Host field                           ", hostTemp);
    debug("Url Path field                       ", url->urlPath);
    //######################## debug code ########################

    if ((url->h=gethostbyname(hostTemp)) == NULL) {  
        herror("gethostbyname");
        exit(1);
    }

    //######################## debug code ########################
    debug("Host name                            ", url->h->h_name);
    sprintf(debugString_4, "%d", inet_ntoa(*((struct in_addr *)url->h->h_addr)));
    debug("IP Address                           ", debugString_4);
    //######################## debug code ########################

    return;
}